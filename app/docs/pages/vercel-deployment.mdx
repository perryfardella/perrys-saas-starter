# Deploy to Vercel

Learn how to deploy your SaaS application to Vercel with automatic deployments and environment configuration.

## Vercel Overview

Vercel is the perfect hosting platform for Next.js applications, offering:

- **Zero-config deployments** from Git repositories
- **Automatic HTTPS** and global CDN
- **Serverless functions** for API routes
- **Preview deployments** for every pull request
- **Edge runtime** for improved performance

## Prerequisites

Before deploying, ensure you have:

- ✅ Supabase project set up and configured
- ✅ Environment variables documented
- ✅ Database migrations applied
- ✅ Application tested locally

## Deployment Steps

### 1. Connect to Vercel

#### Option A: Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy from project directory
vercel

# Follow the prompts:
# - Set up and deploy? [Y/n] Y
# - Which scope? [your-team]
# - Link to existing project? [y/N] N
# - Project name: [your-project-name]
# - Directory: ./
# - Want to override settings? [y/N] N
```

#### Option B: GitHub Integration

1. Go to [vercel.com](https://vercel.com)
2. Sign in with GitHub
3. Click "New Project"
4. Import your repository
5. Configure project settings

### 2. Configure Environment Variables

Add all environment variables in Vercel dashboard:

```bash
# Core configuration
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=your_production_secret

# Supabase configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# OAuth providers (if configured)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# Other services
STRIPE_SECRET_KEY=your_stripe_secret_key
RESEND_API_KEY=your_resend_api_key
```

### 3. Update Supabase Configuration

Update your Supabase authentication settings:

#### Site URL

```
https://your-domain.vercel.app
```

#### Redirect URLs

```
https://your-domain.vercel.app/auth/callback
https://your-domain.vercel.app/auth/confirm
```

### 4. Custom Domain (Optional)

#### Add Custom Domain

1. Go to Project Settings > Domains
2. Add your custom domain
3. Configure DNS records:

```dns
# For root domain (example.com)
A record: @ -> 76.76.19.19

# For subdomain (www.example.com)
CNAME record: www -> cname.vercel-dns.com
```

#### Update Environment Variables

```bash
NEXTAUTH_URL=https://yourdomain.com
```

## Project Configuration

### vercel.json Configuration

Create `vercel.json` for advanced configuration:

```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "regions": ["iad1"],
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "Access-Control-Allow-Origin",
          "value": "*"
        },
        {
          "key": "Access-Control-Allow-Methods",
          "value": "GET, POST, PUT, DELETE, OPTIONS"
        },
        {
          "key": "Access-Control-Allow-Headers",
          "value": "Content-Type, Authorization"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/old-page",
      "destination": "/new-page",
      "permanent": true
    }
  ]
}
```

### Package.json Scripts

Ensure your `package.json` has the correct scripts:

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  }
}
```

### Build Optimization

```typescript
// next.config.mjs
import createMDX from "@next/mdx";

/** @type {import('next').NextConfig} */
const nextConfig = {
  pageExtensions: ["js", "jsx", "md", "mdx", "ts", "tsx"],
  experimental: {
    // Enable for better performance
    optimizeCss: true,
  },
  // Optimize images
  images: {
    domains: ["your-supabase-project.supabase.co"],
    formats: ["image/webp", "image/avif"],
  },
  // Compress responses
  compress: true,
  // Enable SWC minification
  swcMinify: true,
};

const withMDX = createMDX({});
export default withMDX(nextConfig);
```

## Environment-Specific Configuration

### Development Environment

```bash
# .env.local
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
# ... other variables
```

### Staging Environment

```bash
# Vercel staging environment variables
NEXTAUTH_URL=https://your-project-staging.vercel.app
NEXT_PUBLIC_SUPABASE_URL=https://your-staging-project.supabase.co
# ... staging-specific variables
```

### Production Environment

```bash
# Vercel production environment variables
NEXTAUTH_URL=https://yourdomain.com
NEXT_PUBLIC_SUPABASE_URL=https://your-prod-project.supabase.co
# ... production variables
```

## Automatic Deployments

### Git Integration

Vercel automatically deploys when you:

1. **Push to main branch** → Production deployment
2. **Push to other branches** → Preview deployment
3. **Open pull request** → Preview deployment with unique URL

### Branch Configuration

```json
// vercel.json
{
  "git": {
    "deploymentEnabled": {
      "main": true,
      "staging": true
    }
  }
}
```

### Deployment Hooks

```typescript
// Optional: Deploy hooks for external triggers
// POST https://api.vercel.com/v1/integrations/deploy/your-hook-id
```

## Database Migrations

### Manual Migration

```bash
# Connect to production database
supabase link --project-ref your-prod-project-ref

# Apply migrations
supabase db push
```

### Automated Migration

Create a deployment script:

```bash
#!/bin/bash
# deploy.sh

echo "Applying database migrations..."
supabase db push

echo "Deploying to Vercel..."
vercel --prod

echo "Deployment complete!"
```

## Performance Optimization

### Edge Runtime

Use Edge Runtime for better performance:

```typescript
// app/api/edge-example/route.ts
export const runtime = "edge";

export async function GET() {
  return new Response("Hello from the edge!");
}
```

### Static Generation

Optimize for static generation where possible:

```typescript
// app/page.tsx
export default function HomePage() {
  return <div>Static content</div>;
}

// This page will be statically generated
export const dynamic = "force-static";
```

### Image Optimization

```typescript
// components/optimized-image.tsx
import Image from "next/image";

export function OptimizedImage({ src, alt, ...props }) {
  return (
    <Image
      src={src}
      alt={alt}
      quality={85}
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,..."
      {...props}
    />
  );
}
```

## Monitoring & Analytics

### Vercel Analytics

```typescript
// app/layout.tsx
import { Analytics } from "@vercel/analytics/react";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  );
}
```

### Performance Monitoring

```typescript
// lib/performance.ts
export function trackPerformance(name: string, fn: () => Promise<any>) {
  return async () => {
    const start = performance.now();
    try {
      const result = await fn();
      const duration = performance.now() - start;
      console.log(`${name} took ${duration}ms`);
      return result;
    } catch (error) {
      const duration = performance.now() - start;
      console.error(`${name} failed after ${duration}ms:`, error);
      throw error;
    }
  };
}
```

### Error Tracking

```typescript
// lib/error-tracking.ts
export function reportError(error: Error, context?: any) {
  // Send to your error tracking service
  console.error("Application error:", error, context);

  // Optional: Send to external service like Sentry
  if (typeof window !== "undefined") {
    // Client-side error tracking
  }
}
```

## CI/CD Pipeline

### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Build application
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

### Pre-deployment Checks

```bash
# scripts/pre-deploy.sh
#!/bin/bash

echo "Running pre-deployment checks..."

# Type checking
npm run type-check
if [ $? -ne 0 ]; then
  echo "❌ TypeScript errors found"
  exit 1
fi

# Linting
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ Linting errors found"
  exit 1
fi

# Build test
npm run build
if [ $? -ne 0 ]; then
  echo "❌ Build failed"
  exit 1
fi

echo "✅ All checks passed"
```

## Troubleshooting

### Common Issues

#### Build Failures

```bash
# Check build logs in Vercel dashboard
# Common fixes:

# 1. Missing environment variables
# Add all required env vars in Vercel dashboard

# 2. TypeScript errors
npm run type-check

# 3. Missing dependencies
npm install

# 4. Node version mismatch
# Set Node.js version in package.json:
{
  "engines": {
    "node": ">=18.0.0"
  }
}
```

#### Runtime Errors

```typescript
// Add error boundaries
import { ErrorBoundary } from "react-error-boundary";

function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div role="alert">
      <h2>Something went wrong:</h2>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>Try again</button>
    </div>
  );
}

export default function App() {
  return (
    <ErrorBoundary FallbackComponent={ErrorFallback}>
      <YourApp />
    </ErrorBoundary>
  );
}
```

#### Database Connection Issues

```typescript
// Check Supabase URL and keys
// Verify RLS policies
// Test with service role key for debugging
```

### Performance Issues

```bash
# Analyze bundle size
npm install -g @next/bundle-analyzer
ANALYZE=true npm run build

# Check Core Web Vitals in Vercel dashboard
# Optimize images and static assets
# Use Edge Runtime where appropriate
```

## Security Considerations

### Environment Variables

```bash
# Never commit sensitive variables
# Use different keys for staging/production
# Rotate keys regularly
# Use Vercel's encrypted environment variables
```

### Headers

```typescript
// next.config.mjs
const nextConfig = {
  async headers() {
    return [
      {
        source: "/(.*)",
        headers: [
          {
            key: "X-Frame-Options",
            value: "DENY",
          },
          {
            key: "X-Content-Type-Options",
            value: "nosniff",
          },
          {
            key: "Referrer-Policy",
            value: "origin-when-cross-origin",
          },
        ],
      },
    ];
  },
};
```

## Post-Deployment Checklist

- [ ] Application loads correctly
- [ ] Authentication works (sign up/in/out)
- [ ] Database operations function properly
- [ ] API endpoints respond correctly
- [ ] Environment variables are set
- [ ] Custom domain configured (if applicable)
- [ ] SSL certificate is active
- [ ] Error tracking is working
- [ ] Analytics are collecting data
- [ ] Performance metrics look good

## Scaling Considerations

### Database Scaling

```bash
# Monitor Supabase usage
# Consider database connection pooling
# Implement read replicas if needed
# Optimize queries and indexes
```

### Application Scaling

```bash
# Use Vercel Pro for higher limits
# Implement caching strategies
# Consider edge functions for global performance
# Monitor serverless function execution time
```

### Cost Optimization

```bash
# Monitor Vercel usage and costs
# Optimize function execution time
# Use static generation where possible
# Implement efficient caching
```

## Next Steps

- [Set up monitoring](/docs/monitoring) for your deployed application
- [Configure error tracking](/docs/error-handling) for production issues
- [Implement analytics](/docs/analytics) to track user behavior
- [Set up staging environments](/docs/staging) for safe deployments
