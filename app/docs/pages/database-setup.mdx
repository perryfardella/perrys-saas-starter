# Database Setup

Learn how to set up and manage your Supabase PostgreSQL database with tables, relationships, and security policies.

## Database Overview

Your SaaS starter uses Supabase PostgreSQL with:

- **Row Level Security (RLS)** for data protection
- **Real-time subscriptions** for live updates
- **Automatic API generation** from your schema
- **Built-in authentication** integration

## Creating Tables

### User Profiles Table

Extend the default auth.users with additional profile information:

```sql
-- Create user profiles table
CREATE TABLE user_profiles (
  id uuid REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  username text UNIQUE,
  full_name text,
  bio text,
  avatar_url text,
  website text,
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Enable RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Public profiles are viewable by everyone" ON user_profiles
  FOR SELECT USING (true);

CREATE POLICY "Users can update own profile" ON user_profiles
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON user_profiles
  FOR INSERT WITH CHECK (auth.uid() = id);
```

### Organizations Table

For multi-tenant SaaS applications:

```sql
-- Create organizations table
CREATE TABLE organizations (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name text NOT NULL,
  slug text UNIQUE NOT NULL,
  description text,
  logo_url text,
  website text,
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Enable RLS
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;

-- Organization memberships
CREATE TABLE organization_members (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  organization_id uuid REFERENCES organizations(id) ON DELETE CASCADE,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  role text NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL,
  UNIQUE(organization_id, user_id)
);

-- Enable RLS
ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;
```

## Row Level Security Policies

### Basic User Policies

```sql
-- Users can read their own data
CREATE POLICY "Users can view own data" ON user_profiles
  FOR SELECT USING (auth.uid() = id);

-- Users can update their own data
CREATE POLICY "Users can update own data" ON user_profiles
  FOR UPDATE USING (auth.uid() = id);
```

### Organization-Based Policies

```sql
-- Users can view organizations they belong to
CREATE POLICY "Users can view own organizations" ON organizations
  FOR SELECT USING (
    id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
    )
  );

-- Organization admins can update organization
CREATE POLICY "Admins can update organization" ON organizations
  FOR UPDATE USING (
    id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );
```

### Advanced RLS Examples

```sql
-- Content that users own or is public
CREATE POLICY "Users can view own or public content" ON posts
  FOR SELECT USING (
    user_id = auth.uid() OR is_public = true
  );

-- Team-based access
CREATE POLICY "Team members can view team content" ON projects
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members
      WHERE user_id = auth.uid()
    )
  );
```

## Database Functions

### Get User Profile Function

```sql
CREATE OR REPLACE FUNCTION get_user_profile(user_uuid uuid)
RETURNS TABLE (
  id uuid,
  username text,
  full_name text,
  bio text,
  avatar_url text,
  created_at timestamp
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN QUERY
  SELECT
    up.id,
    up.username,
    up.full_name,
    up.bio,
    up.avatar_url,
    up.created_at
  FROM user_profiles up
  WHERE up.id = user_uuid;
END;
$$;
```

### Organization Management Functions

```sql
-- Create organization with owner
CREATE OR REPLACE FUNCTION create_organization_with_owner(
  org_name text,
  org_slug text,
  owner_id uuid
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  org_id uuid;
BEGIN
  -- Insert organization
  INSERT INTO organizations (name, slug)
  VALUES (org_name, org_slug)
  RETURNING id INTO org_id;

  -- Add owner as member
  INSERT INTO organization_members (organization_id, user_id, role)
  VALUES (org_id, owner_id, 'owner');

  RETURN org_id;
END;
$$;
```

## Triggers & Automation

### Auto-Update Timestamps

```sql
-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = timezone('utc'::text, now());
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply to tables
CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_organizations_updated_at
  BEFORE UPDATE ON organizations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Auto-Create User Profile

```sql
-- Function to create user profile on signup
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO user_profiles (id, username, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data->>'username',
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger on user creation
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

## Working with the Database

### Using the Supabase Client

```typescript
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

const supabase = createClientComponentClient();

// Insert data
const { data, error } = await supabase.from("user_profiles").insert({
  id: user.id,
  username: "johndoe",
  full_name: "John Doe",
});

// Query data
const { data: profile } = await supabase
  .from("user_profiles")
  .select("*")
  .eq("id", user.id)
  .single();

// Update data
const { error } = await supabase
  .from("user_profiles")
  .update({ bio: "Updated bio" })
  .eq("id", user.id);
```

### Real-time Subscriptions

```typescript
// Subscribe to changes
const subscription = supabase
  .channel("user_profiles")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "user_profiles" },
    (payload) => {
      console.log("Change received!", payload);
    }
  )
  .subscribe();

// Cleanup
return () => {
  subscription.unsubscribe();
};
```

### Complex Queries

```typescript
// Join tables
const { data } = await supabase
  .from("posts")
  .select(
    `
    *,
    user_profiles (
      username,
      full_name,
      avatar_url
    ),
    categories (
      name,
      color
    )
  `
  )
  .eq("published", true)
  .order("created_at", { ascending: false });

// Filtering and pagination
const { data } = await supabase
  .from("posts")
  .select("*")
  .ilike("title", `%${searchTerm}%`)
  .range(start, end)
  .order("created_at", { ascending: false });
```

## Database Migrations

### Creating Migrations

```sql
-- Migration: 001_initial_setup.sql
-- Create initial tables and policies

BEGIN;

-- Create user profiles table
CREATE TABLE user_profiles (
  -- table definition
);

-- Enable RLS and create policies
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
-- ... policies

COMMIT;
```

### Migration Management

```bash
# Using Supabase CLI
supabase migration new initial_setup
supabase db push
supabase db reset # Reset to migrations
```

## Performance Optimization

### Indexes

```sql
-- Performance indexes
CREATE INDEX idx_user_profiles_username ON user_profiles(username);
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
CREATE INDEX idx_organization_members_user_id ON organization_members(user_id);

-- Composite indexes
CREATE INDEX idx_posts_user_published ON posts(user_id, published, created_at DESC);
```

### Query Optimization

```sql
-- Use EXPLAIN ANALYZE to understand query performance
EXPLAIN ANALYZE
SELECT * FROM posts
WHERE user_id = 'uuid'
AND published = true
ORDER BY created_at DESC
LIMIT 10;
```

## Backup & Recovery

### Automated Backups

Supabase provides automatic backups, but you can also:

```bash
# Manual backup using pg_dump
pg_dump "postgresql://postgres:[password]@db.[ref].supabase.co:5432/postgres" > backup.sql

# Restore from backup
psql "postgresql://postgres:[password]@db.[ref].supabase.co:5432/postgres" < backup.sql
```

## Security Best Practices

### 1. Always Use RLS

```sql
-- Enable RLS on all tables
ALTER TABLE your_table ENABLE ROW LEVEL SECURITY;

-- Create appropriate policies
CREATE POLICY "policy_name" ON your_table
  FOR SELECT USING (/* your security logic */);
```

### 2. Use Service Role Carefully

```typescript
// Only use service role for admin operations
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!, // Server-side only!
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);
```

### 3. Validate Input

```typescript
import { z } from "zod";

const userProfileSchema = z.object({
  username: z
    .string()
    .min(3)
    .max(30)
    .regex(/^[a-zA-Z0-9_]+$/),
  full_name: z.string().min(1).max(100),
  bio: z.string().max(500).optional(),
});

// Validate before database operations
const validatedData = userProfileSchema.parse(inputData);
```

## Monitoring & Analytics

### Database Metrics

Monitor in Supabase dashboard:

- Connection usage
- Query performance
- Storage usage
- API requests

### Custom Logging

```sql
-- Log important operations
CREATE TABLE audit_logs (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES auth.users(id),
  action text NOT NULL,
  table_name text NOT NULL,
  record_id uuid,
  old_values jsonb,
  new_values jsonb,
  created_at timestamp DEFAULT timezone('utc'::text, now())
);
```

## Next Steps

- [Learn about API development](/docs/api-overview) with your database
- [Set up migrations](/docs/migrations) for schema changes
- [Explore RLS policies](/docs/rls-policies) for advanced security
