# Social Authentication

Set up OAuth providers like Google and GitHub for seamless user authentication.

## Supported Providers

Your SaaS starter supports the following OAuth providers out of the box:

- **Google** - Most popular option
- **GitHub** - Great for developer-focused apps
- **Discord** - Perfect for community-driven apps
- **Twitter** - Social media integration
- **Facebook** - Wide user reach

## Google OAuth Setup

### 1. Google Cloud Console Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing one
3. Enable the Google+ API:
   - Go to "APIs & Services" > "Library"
   - Search for "Google+ API"
   - Click "Enable"

### 2. Create OAuth Credentials

1. Go to "APIs & Services" > "Credentials"
2. Click "Create Credentials" > "OAuth 2.0 Client IDs"
3. Choose "Web application"
4. Configure the settings:

**Authorized JavaScript origins:**

```
http://localhost:3000
https://yourdomain.com
```

**Authorized redirect URIs:**

```
https://your-project.supabase.co/auth/v1/callback
```

5. Save your Client ID and Client Secret

### 3. Configure Supabase

1. Go to your Supabase dashboard
2. Navigate to "Authentication" > "Providers"
3. Find "Google" and toggle it on
4. Enter your credentials:
   - **Client ID**: From Google Cloud Console
   - **Client Secret**: From Google Cloud Console
5. Save the configuration

## GitHub OAuth Setup

### 1. GitHub App Registration

1. Go to GitHub Settings > Developer settings > OAuth Apps
2. Click "New OAuth App"
3. Fill in the application details:

**Application name:** Your SaaS App Name
**Homepage URL:** `https://yourdomain.com`
**Authorization callback URL:** `https://your-project.supabase.co/auth/v1/callback`

4. Register the application
5. Note your Client ID and generate a Client Secret

### 2. Configure Supabase

1. In your Supabase dashboard
2. Go to "Authentication" > "Providers"
3. Find "GitHub" and enable it
4. Enter your GitHub OAuth credentials
5. Save the settings

## Environment Variables

Add the OAuth credentials to your environment:

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Optional: Direct OAuth credentials (if not using Supabase config)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
```

## Implementation

### Social Auth Buttons Component

Your starter includes a reusable component at `components/auth/social-auth-buttons.tsx`:

```typescript
"use client";

import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { useState } from "react";

export function SocialAuthButtons() {
  const [loading, setLoading] = useState<string | null>(null);
  const supabase = createClientComponentClient();

  const handleOAuthSignIn = async (
    provider: "google" | "github" | "discord"
  ) => {
    setLoading(provider);

    const { error } = await supabase.auth.signInWithOAuth({
      provider,
      options: {
        redirectTo: `${location.origin}/auth/callback`,
        queryParams: {
          access_type: "offline",
          prompt: "consent",
        },
      },
    });

    if (error) {
      console.error(`${provider} OAuth error:`, error.message);
      alert(`Failed to sign in with ${provider}: ${error.message}`);
    }

    setLoading(null);
  };

  return (
    <div className="space-y-3">
      <button
        onClick={() => handleOAuthSignIn("google")}
        disabled={loading === "google"}
        className="w-full flex items-center justify-center gap-3 px-4 py-3 
                   border border-gray-300 rounded-lg hover:bg-gray-50 
                   disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        {loading === "google" ? (
          <div className="w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin" />
        ) : (
          <GoogleIcon className="w-5 h-5" />
        )}
        Continue with Google
      </button>

      <button
        onClick={() => handleOAuthSignIn("github")}
        disabled={loading === "github"}
        className="w-full flex items-center justify-center gap-3 px-4 py-3 
                   border border-gray-300 rounded-lg hover:bg-gray-50 
                   disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        {loading === "github" ? (
          <div className="w-5 h-5 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin" />
        ) : (
          <GitHubIcon className="w-5 h-5" />
        )}
        Continue with GitHub
      </button>
    </div>
  );
}
```

### OAuth Callback Handler

The callback is handled at `app/auth/callback/route.ts`:

```typescript
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import { NextRequest, NextResponse } from "next/server";

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get("code");

  if (code) {
    const supabase = createRouteHandlerClient({ cookies });
    await supabase.auth.exchangeCodeForSession(code);
  }

  // Redirect to dashboard or intended destination
  return NextResponse.redirect(`${requestUrl.origin}/dashboard`);
}
```

## Advanced Configuration

### Custom OAuth Scopes

Request additional permissions from OAuth providers:

```typescript
const { error } = await supabase.auth.signInWithOAuth({
  provider: "google",
  options: {
    redirectTo: `${location.origin}/auth/callback`,
    scopes: "openid email profile",
    queryParams: {
      access_type: "offline",
      prompt: "consent",
    },
  },
});
```

### Provider-Specific Settings

#### Google

```typescript
// Request offline access for refresh tokens
queryParams: {
  access_type: 'offline',
  prompt: 'consent',
}
```

#### GitHub

```typescript
// Request specific scopes
scopes: "user:email read:user";
```

### Account Linking

Allow users to link multiple OAuth accounts:

```typescript
const linkAccount = async (provider: string) => {
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    throw new Error("User must be signed in to link accounts");
  }

  const { error } = await supabase.auth.linkIdentity({
    provider,
    options: {
      redirectTo: `${location.origin}/dashboard/settings`,
    },
  });

  if (error) {
    console.error("Account linking error:", error);
  }
};
```

## User Data Handling

### Extracting Profile Information

OAuth providers return different user data structures:

```typescript
// In your auth callback or user profile component
const getUserProfileData = (user: any) => {
  const provider = user.app_metadata?.provider;

  switch (provider) {
    case "google":
      return {
        full_name: user.user_metadata?.full_name,
        avatar_url: user.user_metadata?.avatar_url,
        email_verified: user.user_metadata?.email_verified,
      };

    case "github":
      return {
        full_name: user.user_metadata?.full_name || user.user_metadata?.name,
        avatar_url: user.user_metadata?.avatar_url,
        username: user.user_metadata?.user_name,
        github_url: user.user_metadata?.html_url,
      };

    default:
      return {
        full_name: user.user_metadata?.full_name,
        avatar_url: user.user_metadata?.avatar_url,
      };
  }
};
```

### Storing Additional Profile Data

Create a user profiles table to store additional information:

```sql
-- Create user profiles table
CREATE TABLE user_profiles (
  id uuid REFERENCES auth.users(id) PRIMARY KEY,
  full_name text,
  avatar_url text,
  username text UNIQUE,
  bio text,
  website text,
  github_url text,
  twitter_handle text,
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);

-- Enable RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view own profile" ON user_profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON user_profiles
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON user_profiles
  FOR INSERT WITH CHECK (auth.uid() = id);
```

### Automatic Profile Creation

Create user profiles automatically on first OAuth sign-in:

```typescript
// In your auth callback or profile creation logic
const createOrUpdateProfile = async (user: any) => {
  const supabase = createClientComponentClient();
  const profileData = getUserProfileData(user);

  const { data, error } = await supabase
    .from("user_profiles")
    .upsert({
      id: user.id,
      ...profileData,
      updated_at: new Date().toISOString(),
    })
    .select()
    .single();

  if (error && error.code !== "23505") {
    // Ignore unique constraint violations
    console.error("Profile creation error:", error);
  }

  return data;
};
```

## Security Considerations

### 1. Validate Redirect URLs

Always validate OAuth redirect URLs:

```typescript
const allowedOrigins = [
  "http://localhost:3000",
  "https://yourdomain.com",
  "https://staging.yourdomain.com",
];

const validateRedirectUrl = (url: string) => {
  try {
    const redirectUrl = new URL(url);
    return allowedOrigins.includes(redirectUrl.origin);
  } catch {
    return false;
  }
};
```

### 2. Handle OAuth Errors

Implement proper error handling:

```typescript
const handleOAuthError = (error: any) => {
  switch (error.message) {
    case "OAuth state parameter is missing":
      return "Authentication was interrupted. Please try again.";
    case "OAuth code parameter is missing":
      return "Authentication failed. Please try again.";
    default:
      return "Failed to sign in with social provider. Please try again.";
  }
};
```

### 3. Rate Limiting

Consider implementing rate limiting for OAuth endpoints to prevent abuse.

## Testing OAuth

### Local Testing Setup

For local development, use tools like ngrok to test OAuth flows:

```bash
# Install ngrok
npm install -g ngrok

# Expose local server
ngrok http 3000

# Use the ngrok URL as your OAuth redirect URL during development
```

### Testing Checklist

- [ ] OAuth sign-up creates new user
- [ ] OAuth sign-in works for existing users
- [ ] Error handling works correctly
- [ ] User profile data is extracted properly
- [ ] Account linking works (if implemented)
- [ ] Sign-out clears OAuth sessions
- [ ] Redirect URLs are validated

## Troubleshooting

### Common Issues

**"OAuth state parameter is missing"**

- Check that your redirect URLs match exactly
- Ensure cookies are enabled in the browser
- Verify your Supabase configuration

**"Redirect URI mismatch"**

- Check OAuth app settings in provider dashboard
- Ensure URLs match exactly (including http/https)
- Verify no trailing slashes

**Provider not showing up**

- Check Supabase provider configuration
- Verify provider is enabled
- Ensure credentials are correct

**User data not available**

- Check OAuth scopes requested
- Verify provider returns expected data
- Check user_metadata in Supabase auth users table

## Next Steps

- [Learn about database setup](/docs/database-setup) for user profiles
- [Explore API development](/docs/api-overview) with authenticated users
- [Set up email customization](/docs/email-templates) for OAuth users
