# Migrations

Learn how to create and manage database schema changes safely using Supabase migrations.

## What are Migrations?

Database migrations are version-controlled scripts that modify your database schema. They allow you to:

- Track database changes over time
- Share schema changes with your team
- Deploy database updates safely
- Rollback changes if needed

## Migration Workflow

1. **Create Migration**: Write SQL to modify your schema
2. **Test Locally**: Apply migration to local database
3. **Review Changes**: Ensure migration is safe and reversible
4. **Deploy**: Apply migration to staging/production

## Creating Migrations

### Using Supabase CLI

```bash
# Create a new migration
supabase migration new add_user_profiles_table

# This creates a file like: supabase/migrations/20240115123456_add_user_profiles_table.sql
```

### Migration File Structure

```sql
-- Migration: 20240115123456_add_user_profiles_table.sql

-- Add new table
CREATE TABLE user_profiles (
  id uuid REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  username text UNIQUE,
  full_name text,
  bio text,
  avatar_url text,
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Enable RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Create indexes
CREATE INDEX idx_user_profiles_username ON user_profiles(username);

-- Create policies
CREATE POLICY "Public profiles are viewable by everyone" ON user_profiles
  FOR SELECT USING (true);

CREATE POLICY "Users can update own profile" ON user_profiles
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON user_profiles
  FOR INSERT WITH CHECK (auth.uid() = id);
```

## Common Migration Patterns

### Adding Tables

```sql
-- Migration: add_posts_table.sql
CREATE TABLE posts (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  title text NOT NULL,
  content text,
  slug text UNIQUE NOT NULL,
  published boolean DEFAULT false,
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Add indexes
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_slug ON posts(slug);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);

-- Enable RLS
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

-- Add policies
CREATE POLICY "Users can view published posts" ON posts
  FOR SELECT USING (published = true OR user_id = auth.uid());

CREATE POLICY "Users can manage their own posts" ON posts
  USING (user_id = auth.uid());
```

### Adding Columns

```sql
-- Migration: add_email_preferences.sql
ALTER TABLE user_profiles
ADD COLUMN email_notifications boolean DEFAULT true,
ADD COLUMN marketing_emails boolean DEFAULT false,
ADD COLUMN newsletter_subscribed boolean DEFAULT true;

-- Add index if needed
CREATE INDEX idx_user_profiles_email_notifications
ON user_profiles(email_notifications)
WHERE email_notifications = true;
```

### Modifying Columns

```sql
-- Migration: modify_user_bio_length.sql

-- Make bio longer
ALTER TABLE user_profiles
ALTER COLUMN bio TYPE text;

-- Add constraint
ALTER TABLE user_profiles
ADD CONSTRAINT user_profiles_bio_length
CHECK (length(bio) <= 1000);
```

### Adding Foreign Keys

```sql
-- Migration: add_category_relationship.sql

-- First add the column
ALTER TABLE posts ADD COLUMN category_id uuid;

-- Create the categories table if it doesn't exist
CREATE TABLE categories (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  name text NOT NULL,
  slug text UNIQUE NOT NULL,
  description text,
  color text DEFAULT '#3B82F6',
  created_at timestamp DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Add foreign key constraint
ALTER TABLE posts
ADD CONSTRAINT fk_posts_category
FOREIGN KEY (category_id) REFERENCES categories(id);

-- Add index
CREATE INDEX idx_posts_category_id ON posts(category_id);
```

## Advanced Migration Techniques

### Data Migrations

```sql
-- Migration: migrate_user_data.sql

-- Add new column
ALTER TABLE user_profiles ADD COLUMN display_name text;

-- Migrate existing data
UPDATE user_profiles
SET display_name = COALESCE(full_name, username, 'User')
WHERE display_name IS NULL;

-- Make column required
ALTER TABLE user_profiles
ALTER COLUMN display_name SET NOT NULL;
```

### Conditional Migrations

```sql
-- Migration: conditional_changes.sql

-- Only add column if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'user_profiles'
    AND column_name = 'timezone'
  ) THEN
    ALTER TABLE user_profiles ADD COLUMN timezone text DEFAULT 'UTC';
  END IF;
END $$;
```

### Renaming Tables/Columns

```sql
-- Migration: rename_user_settings.sql

-- Rename table
ALTER TABLE user_preferences RENAME TO user_settings;

-- Rename column
ALTER TABLE user_settings
RENAME COLUMN notification_preferences TO notifications;

-- Update any dependent views or functions
DROP VIEW IF EXISTS user_notification_view;
CREATE VIEW user_notification_view AS
SELECT
  id,
  notifications->>'email' as email_notifications,
  notifications->>'push' as push_notifications
FROM user_settings;
```

## Managing RLS in Migrations

### Adding RLS Policies

```sql
-- Migration: add_organization_policies.sql

-- Enable RLS on new table
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view organizations they belong to" ON organizations
  FOR SELECT USING (
    id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Organization admins can update" ON organizations
  FOR UPDATE USING (
    id IN (
      SELECT organization_id FROM organization_members
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );
```

### Updating Existing Policies

```sql
-- Migration: update_posts_policies.sql

-- Drop existing policy
DROP POLICY IF EXISTS "Users can view own posts" ON posts;

-- Create updated policy
CREATE POLICY "Users can view own or public posts" ON posts
  FOR SELECT USING (
    user_id = auth.uid() OR published = true
  );
```

## Functions and Triggers

### Adding Database Functions

```sql
-- Migration: add_utility_functions.sql

-- Function to generate slugs
CREATE OR REPLACE FUNCTION generate_slug(title text)
RETURNS text AS $$
BEGIN
  RETURN lower(
    regexp_replace(
      regexp_replace(title, '[^a-zA-Z0-9\s]', '', 'g'),
      '\s+', '-', 'g'
    )
  );
END;
$$ LANGUAGE plpgsql;

-- Function to update timestamps
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = timezone('utc'::text, now());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### Adding Triggers

```sql
-- Migration: add_auto_slug_trigger.sql

-- Trigger to auto-generate slugs
CREATE OR REPLACE FUNCTION auto_generate_slug()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.slug IS NULL OR NEW.slug = '' THEN
    NEW.slug = generate_slug(NEW.title);

    -- Ensure uniqueness
    WHILE EXISTS (SELECT 1 FROM posts WHERE slug = NEW.slug AND id != NEW.id) LOOP
      NEW.slug = NEW.slug || '-' || substr(gen_random_uuid()::text, 1, 8);
    END LOOP;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply trigger
CREATE TRIGGER trigger_auto_generate_slug
  BEFORE INSERT OR UPDATE ON posts
  FOR EACH ROW EXECUTE FUNCTION auto_generate_slug();
```

## Testing Migrations

### Local Testing

```bash
# Reset local database to migrations
supabase db reset

# Apply specific migration
supabase migration up --to 20240115123456

# Check migration status
supabase migration list
```

### Migration Validation

```sql
-- Add to migration for validation
DO $$
BEGIN
  -- Verify table exists
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_name = 'user_profiles'
  ) THEN
    RAISE EXCEPTION 'user_profiles table was not created';
  END IF;

  -- Verify column exists
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'user_profiles' AND column_name = 'username'
  ) THEN
    RAISE EXCEPTION 'username column was not added';
  END IF;

  RAISE NOTICE 'Migration validation passed';
END $$;
```

## Deployment Strategies

### Staging Environment

```bash
# Deploy to staging first
supabase link --project-ref staging-project-id
supabase db push

# Test in staging
# Run application tests
# Verify data integrity
```

### Production Deployment

```bash
# Deploy to production
supabase link --project-ref production-project-id
supabase db push --dry-run  # Preview changes
supabase db push            # Apply changes
```

### Zero-Downtime Migrations

For large tables or breaking changes:

```sql
-- Step 1: Add new column (non-breaking)
ALTER TABLE users ADD COLUMN new_email text;

-- Step 2: Populate new column
UPDATE users SET new_email = email WHERE new_email IS NULL;

-- Step 3: Update application to use new column
-- (Deploy application changes)

-- Step 4: Make new column required
ALTER TABLE users ALTER COLUMN new_email SET NOT NULL;

-- Step 5: Remove old column (after confirming everything works)
ALTER TABLE users DROP COLUMN email;
```

## Rollback Strategies

### Creating Rollback Migrations

```sql
-- Migration: 20240115123456_add_posts_table.sql (forward)
CREATE TABLE posts (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  title text NOT NULL,
  -- ... other columns
);

-- Rollback: 20240115123457_rollback_add_posts_table.sql
DROP TABLE IF EXISTS posts;
```

### Safe Rollback Practices

```sql
-- Before dropping columns, rename them first
-- Migration: rename_old_column.sql
ALTER TABLE users RENAME COLUMN old_email TO old_email_deprecated;

-- Later migration: remove_deprecated_column.sql
ALTER TABLE users DROP COLUMN IF EXISTS old_email_deprecated;
```

## Best Practices

### 1. Make Migrations Idempotent

```sql
-- Use IF NOT EXISTS
CREATE TABLE IF NOT EXISTS new_table (...);

-- Use conditional logic
DO $$
BEGIN
  IF NOT EXISTS (...) THEN
    -- Make changes
  END IF;
END $$;
```

### 2. Add Indexes Concurrently

```sql
-- For large tables, create indexes without blocking
CREATE INDEX CONCURRENTLY idx_posts_created_at ON posts(created_at);
```

### 3. Use Transactions

```sql
-- Wrap related changes in transactions
BEGIN;
  -- Multiple related changes
  CREATE TABLE ...;
  ALTER TABLE ...;
  CREATE INDEX ...;
COMMIT;
```

### 4. Document Complex Migrations

```sql
-- Migration: complex_user_restructure.sql
/*
 * This migration restructures the user system to support organizations
 *
 * Changes:
 * 1. Creates organizations table
 * 2. Creates organization_members junction table
 * 3. Migrates existing user data
 * 4. Updates RLS policies
 *
 * Rollback plan: See rollback_complex_user_restructure.sql
 */
```

## Troubleshooting

### Common Issues

**Migration fails partway through:**

```bash
# Check current migration status
supabase migration list

# Reset to specific migration
supabase db reset --to 20240115123456
```

**Foreign key constraint errors:**

```sql
-- Disable constraints temporarily
SET session_replication_role = replica;
-- Run migration
SET session_replication_role = DEFAULT;
```

**Large table migrations timeout:**

```sql
-- Break into smaller batches
DO $$
DECLARE
  batch_size INTEGER := 1000;
  total_rows INTEGER;
BEGIN
  LOOP
    UPDATE large_table
    SET new_column = calculate_value(old_column)
    WHERE new_column IS NULL
    LIMIT batch_size;

    GET DIAGNOSTICS total_rows = ROW_COUNT;
    EXIT WHEN total_rows = 0;

    -- Optional: add delay
    PERFORM pg_sleep(0.1);
  END LOOP;
END $$;
```

## Next Steps

- [Learn about RLS policies](/docs/rls-policies) for securing your data
- [Explore edge functions](/docs/edge-functions) for custom database logic
- [Set up deployment](/docs/vercel-deployment) with automatic migrations
